{% extends "base.html" %}

{% block title %}å†å²è®°å½• - TimeLog{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="bi bi-journal"></i> å†å²è®°å½•
                </h5>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="filterByCategory('all')">
                        å…¨éƒ¨
                    </button>
                    <button type="button" class="btn btn-outline-success btn-sm" onclick="filterByCategory('study')">
                        ğŸ“š å­¦ä¹ 
                    </button>
                    <button type="button" class="btn btn-outline-warning btn-sm" onclick="filterByCategory('game')">
                        ğŸ® æ¸¸æˆ
                    </button>
                    <button type="button" class="btn btn-outline-info btn-sm" onclick="filterByCategory('other')">
                        ğŸ“‹ å…¶ä»–
                    </button>
                </div>
            </div>
            <div class="card-body">
                {% if sessions %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th width="10%">å¼€å§‹æ—¥æœŸ</th>
                                <th width="10%">å¼€å§‹æ—¶é—´</th>
                                <th width="10%">ç»“æŸæ—¥æœŸ</th>
                                <th width="10%">ç»“æŸæ—¶é—´</th>
                                <th width="28%">ä»»åŠ¡</th>
                                <th width="8%">ç±»åˆ«</th>
                                <th width="8%">æ—¶é•¿</th>
                                <th width="16%">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="historyTable">
                            {% for session in sessions %}
                            <tr class="session-row" data-category="{{ session.category }}">
                                <td>
                                    <span class="text-muted">
                                        {{ session.date }}
                                    </span>
                                </td>
                                <td>
                                    <small class="text-primary">
                                        <i class="bi bi-play-circle"></i>
                                        {{ session.start_time }}
                                    </small>
                                </td>
                                <td>
                                    {% if session.end_date %}
                                    <span class="text-muted">
                                        {% if session.end_date != session.date %}
                                        <span class="badge bg-warning text-dark">
                                            {{ session.end_date }}
                                        </span>
                                        {% else %}
                                        {{ session.end_date }}
                                        {% endif %}
                                    </span>
                                    {% else %}
                                    <small class="text-warning">
                                        è¿›è¡Œä¸­
                                    </small>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if session.end_time %}
                                    <small class="text-danger">
                                        <i class="bi bi-stop-circle"></i>
                                        {{ session.end_time }}
                                    </small>
                                    {% else %}
                                    <small class="text-warning">
                                        <i class="bi bi-clock"></i>
                                        --:--
                                    </small>
                                    {% endif %}
                                </td>
                                <td>
                                    <strong>{{ session.task }}</strong>
                                </td>
                                <td>
                                    {% if session.category == 'study' %}
                                        <span class="badge bg-success">ğŸ“š å­¦ä¹ </span>
                                    {% elif session.category == 'game' %}
                                        <span class="badge bg-warning">ğŸ® æ¸¸æˆ</span>
                                    {% elif session.category == 'other' %}
                                        <span class="badge bg-info">ğŸ“‹ å…¶ä»–</span>
                                    {% else %}
                                        <span class="badge bg-secondary">{{ session.category }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if session.duration_hours %}
                                    <span class="fw-bold text-primary">
                                        {{ "%.1f"|format(session.duration_hours) }}h
                                    </span>
                                    {% else %}
                                    <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button class="btn btn-outline-primary btn-sm" 
                                                onclick="editSession({{ session.original_index }})" 
                                                title="ç¼–è¾‘ä»»åŠ¡">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button class="btn btn-outline-danger btn-sm" 
                                                onclick="deleteSession({{ session.original_index }})" 
                                                title="åˆ é™¤ä»»åŠ¡">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <!-- åˆ†é¡µä¿¡æ¯ -->
                <div class="row mt-3">
                    <div class="col-sm-6">
                        <p class="text-muted mb-0">
                            æ˜¾ç¤º {{ sessions|length }} æ¡è®°å½•
                        </p>
                    </div>
                    <div class="col-sm-6 text-end">
                        <div class="btn-group" role="group">
                            <button class="btn btn-success btn-sm" onclick="createNewSession()" title="åˆ›å»ºæ–°ä»»åŠ¡">
                                <i class="bi bi-plus-circle"></i> æ–°å»ºä»»åŠ¡
                            </button>
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-outline-primary btn-sm dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="bi bi-download"></i> å¯¼å‡ºæ•°æ®
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" onclick="exportData('csv-utf8')">
                                        <i class="bi bi-file-earmark-spreadsheet"></i> CSV (UTF-8+BOM)
                                    </a></li>
                                    <li><a class="dropdown-item" href="#" onclick="exportDataServer('csv', 'gbk')">
                                        <i class="bi bi-file-earmark-spreadsheet"></i> CSV (GBKï¼Œå…¼å®¹Excel)
                                    </a></li>
                                    <li><a class="dropdown-item" href="#" onclick="exportDataServer('json', 'utf-8')">
                                        <i class="bi bi-file-earmark-code"></i> JSON
                                    </a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item" href="#" onclick="exportData('csv-gbk')">
                                        <i class="bi bi-file-earmark-spreadsheet"></i> CSV (å‰ç«¯ç”Ÿæˆ)
                                    </a></li>
                                </ul>
                            </div>
                            <button class="btn btn-outline-danger btn-sm" onclick="confirmClearData()" title="æ¸…ç©ºæ‰€æœ‰å†å²æ•°æ®">
                                <i class="bi bi-trash"></i> æ¸…ç©ºå†å²
                            </button>
                        </div>
                    </div>
                </div>
                
                {% else %}
                <div class="text-center py-5">
                    <i class="bi bi-journal-x display-4 text-muted"></i>
                    <h4 class="mt-3 text-muted">æš‚æ— å†å²è®°å½•</h4>
                    <p class="text-muted">å¼€å§‹è®°å½•æ‚¨çš„ç¬¬ä¸€ä¸ªä»»åŠ¡å§ï¼</p>
                    <a href="{{ url_for('tasks') }}" class="btn btn-primary">
                        <i class="bi bi-plus-circle"></i> å¼€å§‹ä»»åŠ¡
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- ç»Ÿè®¡æ‘˜è¦å¡ç‰‡ -->
{% if sessions %}
<div class="row mt-4">
    <div class="col-md-3 mb-3">
        <div class="card bg-success bg-opacity-10 border-success">
            <div class="card-body text-center">
                <i class="bi bi-book display-6 text-success"></i>
                <h6 class="card-title mt-2">å­¦ä¹ æ€»æ—¶é—´</h6>
                <h4 class="text-success" id="totalStudyTime">-</h4>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card bg-warning bg-opacity-10 border-warning">
            <div class="card-body text-center">
                <i class="bi bi-controller display-6 text-warning"></i>
                <h6 class="card-title mt-2">æ¸¸æˆæ€»æ—¶é—´</h6>
                <h4 class="text-warning" id="totalGameTime">-</h4>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card bg-info bg-opacity-10 border-info">
            <div class="card-body text-center">
                <i class="bi bi-list-task display-6 text-info"></i>
                <h6 class="card-title mt-2">å…¶ä»–æ€»æ—¶é—´</h6>
                <h4 class="text-info" id="totalOtherTime">-</h4>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card bg-primary bg-opacity-10 border-primary">
            <div class="card-body text-center">
                <i class="bi bi-clock display-6 text-primary"></i>
                <h6 class="card-title mt-2">æ€»è®¡æ—¶é—´</h6>
                <h4 class="text-primary" id="totalTime">-</h4>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- ç¼–è¾‘ä»»åŠ¡æ¨¡æ€æ¡† -->
<div class="modal fade" id="editSessionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editModalTitle">ç¼–è¾‘ä»»åŠ¡</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editSessionForm">
                    <input type="hidden" id="editSessionId">
                    
                    <div class="mb-3">
                        <label for="editTaskName" class="form-label">ä»»åŠ¡åç§°</label>
                        <input type="text" class="form-control" id="editTaskName" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editCategory" class="form-label">ä»»åŠ¡ç±»åˆ«</label>
                        <select class="form-select" id="editCategory" required>
                            <option value="study">ğŸ“š å­¦ä¹ </option>
                            <option value="game">ğŸ® æ¸¸æˆ</option>
                            <option value="other">ğŸ“‹ å…¶ä»–</option>
                        </select>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editStartDate" class="form-label">å¼€å§‹æ—¥æœŸ</label>
                                <input type="date" class="form-control" id="editStartDate" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editStartTime" class="form-label">å¼€å§‹æ—¶é—´</label>
                                <input type="time" class="form-control" id="editStartTime" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editEndDate" class="form-label">ç»“æŸæ—¥æœŸ</label>
                                <input type="date" class="form-control" id="editEndDate">
                                <div class="form-text">ç•™ç©ºè¡¨ç¤ºä»»åŠ¡æ­£åœ¨è¿›è¡Œä¸­</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editEndTime" class="form-label">ç»“æŸæ—¶é—´</label>
                                <input type="time" class="form-control" id="editEndTime">
                                <div class="form-text">æ”¯æŒè·¨å¤©ä»»åŠ¡</div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" id="saveSessionBtn" onclick="saveSession()">ä¿å­˜</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// é¡µé¢åŠ è½½åè®¡ç®—ç»Ÿè®¡
document.addEventListener('DOMContentLoaded', function() {
    updateNavbarStatus();
    calculateTotals();
});

// æŒ‰åˆ†ç±»ç­›é€‰
function filterByCategory(category) {
    const rows = document.querySelectorAll('.session-row');
    const buttons = document.querySelectorAll('.btn-group .btn');
    
    // æ›´æ–°æŒ‰é’®çŠ¶æ€
    buttons.forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    // ç­›é€‰è¡Œ
    rows.forEach(row => {
        if (category === 'all' || row.dataset.category === category) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
    
    calculateTotals();
}

// è®¡ç®—æ€»è®¡æ—¶é—´
function calculateTotals() {
    const visibleRows = document.querySelectorAll('.session-row[style=""], .session-row:not([style])');
    let studyTotal = 0, gameTotal = 0, otherTotal = 0;
    
    visibleRows.forEach(row => {
        const category = row.dataset.category;
        const durationCell = row.cells[6];  // æ—¶é•¿åˆ—ç°åœ¨æ˜¯ç¬¬7åˆ—ï¼ˆç´¢å¼•6ï¼‰
        const durationText = durationCell.textContent.trim();
        
        if (durationText !== '-') {
            const hours = parseFloat(durationText.replace('h', ''));
            if (!isNaN(hours)) {
                switch(category) {
                    case 'study': studyTotal += hours; break;
                    case 'game': gameTotal += hours; break;
                    case 'other': otherTotal += hours; break;
                }
            }
        }
    });
    
    const totalTime = studyTotal + gameTotal + otherTotal;
    
    // æ›´æ–°æ˜¾ç¤ºï¼ˆæ£€æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨ï¼‰
    const studyEl = document.getElementById('totalStudyTime');
    const gameEl = document.getElementById('totalGameTime');
    const otherEl = document.getElementById('totalOtherTime');
    const totalEl = document.getElementById('totalTime');
    
    if (studyEl) studyEl.textContent = studyTotal.toFixed(1) + 'h';
    if (gameEl) gameEl.textContent = gameTotal.toFixed(1) + 'h';
    if (otherEl) otherEl.textContent = otherTotal.toFixed(1) + 'h';
    if (totalEl) totalEl.textContent = totalTime.toFixed(1) + 'h';
}

// å¯¼å‡ºæ•°æ®åŠŸèƒ½
function exportData(format = 'csv-utf8') {
    const visibleRows = document.querySelectorAll('.session-row[style=""], .session-row:not([style])');
    const data = [];
    
    // æ”¶é›†æ•°æ®
    visibleRows.forEach(row => {
        const cells = row.cells;
        const rowData = {
            startDate: cells[0].textContent.trim(),
            startTime: cells[1].textContent.trim().replace(/.*(\d{2}:\d{2}).*/, '$1'),
            endDate: cells[2].textContent.trim(),
            endTime: cells[3].textContent.trim().replace(/.*(\d{2}:\d{2}).*/, '$1'),
            task: cells[4].textContent.trim(),
            category: cells[5].textContent.trim(),
            duration: cells[6].textContent.trim()
        };
        data.push(rowData);
    });
    
    if (data.length === 0) {
        showNotification('âŒ æ²¡æœ‰æ•°æ®å¯å¯¼å‡º', 'error');
        return;
    }
    
    const timestamp = new Date().toISOString().split('T')[0];
    
    if (format === 'json') {
        // JSONæ ¼å¼å¯¼å‡º
        const jsonData = {
            exportDate: new Date().toISOString(),
            totalRecords: data.length,
            data: data
        };
        
        const blob = new Blob([JSON.stringify(jsonData, null, 2)], { 
            type: 'application/json;charset=utf-8;' 
        });
        downloadFile(blob, `timelog_history_${timestamp}.json`);
        showNotification('âœ… JSONæ•°æ®å¯¼å‡ºæˆåŠŸï¼', 'success');
        
    } else if (format === 'csv-gbk') {
        // GBKç¼–ç çš„CSVï¼ˆå…¼å®¹Excelï¼‰
        let csvContent = "å¼€å§‹æ—¥æœŸ,å¼€å§‹æ—¶é—´,ç»“æŸæ—¥æœŸ,ç»“æŸæ—¶é—´,ä»»åŠ¡,ç±»åˆ«,æ—¶é•¿(å°æ—¶)\n";
        
        data.forEach(row => {
            csvContent += `"${row.startDate}","${row.startTime}","${row.endDate}","${row.endTime}","${row.task}","${row.category}","${row.duration}"\n`;
        });
        
        // æ³¨æ„ï¼šå®é™…çš„GBKç¼–ç è½¬æ¢åœ¨æµè§ˆå™¨ä¸­æ¯”è¾ƒå¤æ‚ï¼Œè¿™é‡Œæä¾›ä¸€ä¸ªå˜é€šæ–¹æ¡ˆ
        const blob = new Blob([csvContent], { type: 'text/csv;charset=gbk;' });
        downloadFile(blob, `timelog_history_${timestamp}_gbk.csv`);
        showNotification('âœ… CSVæ•°æ®å¯¼å‡ºæˆåŠŸï¼å¦‚æœExcelä¸­ä»æœ‰ä¹±ç ï¼Œè¯·åœ¨Excelä¸­ä½¿ç”¨"æ•°æ®"->"ä»æ–‡æœ¬"å¯¼å…¥ï¼Œå¹¶é€‰æ‹©UTF-8ç¼–ç ã€‚', 'success');
        
    } else {
        // UTF-8+BOMç¼–ç çš„CSVï¼ˆé»˜è®¤ï¼‰
        let csvContent = "å¼€å§‹æ—¥æœŸ,å¼€å§‹æ—¶é—´,ç»“æŸæ—¥æœŸ,ç»“æŸæ—¶é—´,ä»»åŠ¡,ç±»åˆ«,æ—¶é•¿(å°æ—¶)\n";
        
        data.forEach(row => {
            csvContent += `"${row.startDate}","${row.startTime}","${row.endDate}","${row.endTime}","${row.task}","${row.category}","${row.duration}"\n`;
        });
        
        // æ·»åŠ BOMä»¥ç¡®ä¿Excelæ­£ç¡®è¯†åˆ«UTF-8ç¼–ç 
        const BOM = '\uFEFF';
        const csvWithBOM = BOM + csvContent;
        
        const blob = new Blob([csvWithBOM], { type: 'text/csv;charset=utf-8;' });
        downloadFile(blob, `timelog_history_${timestamp}.csv`);
        showNotification('âœ… CSVæ•°æ®å¯¼å‡ºæˆåŠŸï¼æ·»åŠ äº†BOMæ ‡è®°ä»¥æ”¹å–„Excelå…¼å®¹æ€§ã€‚', 'success');
    }
}

// é€šç”¨æ–‡ä»¶ä¸‹è½½å‡½æ•°
function downloadFile(blob, filename) {
    const link = document.createElement("a");
    const url = URL.createObjectURL(blob);
    link.setAttribute("href", url);
    link.setAttribute("download", filename);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
}

// æœåŠ¡å™¨ç«¯å¯¼å‡ºï¼ˆæ›´å¥½çš„ä¸­æ–‡æ”¯æŒï¼‰
function exportDataServer(format = 'csv', encoding = 'utf-8') {
    const url = `/api/export_data?format=${format}&encoding=${encoding}`;
    
    // æ˜¾ç¤ºåŠ è½½æç¤º
    showNotification('ğŸ“¥ æ­£åœ¨ç”Ÿæˆå¯¼å‡ºæ–‡ä»¶...', 'info');
    
    // åˆ›å»ºéšè—çš„é“¾æ¥æ¥è§¦å‘ä¸‹è½½
    const link = document.createElement('a');
    link.href = url;
    link.style.display = 'none';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    // å»¶è¿Ÿæ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
    setTimeout(() => {
        if (format === 'json') {
            showNotification('âœ… JSONæ•°æ®å¯¼å‡ºæˆåŠŸï¼', 'success');
        } else {
            if (encoding === 'gbk') {
                showNotification('âœ… CSVæ•°æ®å¯¼å‡ºæˆåŠŸï¼ä½¿ç”¨GBKç¼–ç ï¼Œåº”è¯¥èƒ½åœ¨Excelä¸­æ­£ç¡®æ˜¾ç¤ºä¸­æ–‡ã€‚', 'success');
            } else {
                showNotification('âœ… CSVæ•°æ®å¯¼å‡ºæˆåŠŸï¼ä½¿ç”¨UTF-8ç¼–ç ï¼Œæ·»åŠ äº†BOMæ ‡è®°ã€‚', 'success');
            }
        }
    }, 500);
}

// ç¡®è®¤æ¸…ç©ºæ•°æ®
function confirmClearData() {
    // ä½¿ç”¨Bootstrapæ¨¡æ€æ¡†æˆ–è€…æµè§ˆå™¨ç¡®è®¤æ¡†
    const confirmed = confirm(
        'âš ï¸ è­¦å‘Šï¼šæ­¤æ“ä½œå°†æ°¸ä¹…åˆ é™¤æ‰€æœ‰å†å²æ•°æ®ï¼\n\n' +
        'åŒ…æ‹¬ï¼š\n' +
        'â€¢ æ‰€æœ‰ä»»åŠ¡è®°å½•\n' +
        'â€¢ æ‰€æœ‰ç»Ÿè®¡æ•°æ®\n' +
        'â€¢ å½“å‰æ­£åœ¨è¿›è¡Œçš„ä»»åŠ¡\n\n' +
        'æ­¤æ“ä½œæ— æ³•æ’¤é”€ï¼Œç¡®å®šè¦ç»§ç»­å—ï¼Ÿ'
    );
    
    if (confirmed) {
        const doubleConfirm = confirm(
            'ğŸ”´ æœ€åç¡®è®¤ï¼šæ‚¨çœŸçš„è¦åˆ é™¤æ‰€æœ‰æ•°æ®å—ï¼Ÿ\n\n' +
            'åˆ é™¤åå°†æ— æ³•æ¢å¤ï¼'
        );
        
        if (doubleConfirm) {
            clearAllData();
        }
    }
}

// æ‰§è¡Œæ¸…ç©ºæ•°æ®
function clearAllData() {
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    const clearBtn = event.target;
    const originalText = clearBtn.innerHTML;
    clearBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> æ¸…ç©ºä¸­...';
    clearBtn.disabled = true;
    
    fetch('/api/clear_data', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
            showNotification('âœ… ' + data.message, 'success');
            
            // å»¶è¿Ÿåˆ·æ–°é¡µé¢
            setTimeout(() => {
                location.reload();
            }, 1500);
        } else {
            showNotification('âŒ æ¸…ç©ºå¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'), 'error');
            clearBtn.innerHTML = originalText;
            clearBtn.disabled = false;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('âŒ æ¸…ç©ºå¤±è´¥: ç½‘ç»œé”™è¯¯', 'error');
        clearBtn.innerHTML = originalText;
        clearBtn.disabled = false;
    });
}

// æ˜¾ç¤ºé€šçŸ¥æ¶ˆæ¯
function showNotification(message, type = 'info') {
    // åˆ›å»ºé€šçŸ¥å…ƒç´ 
    const notification = document.createElement('div');
    notification.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 1050; min-width: 300px;';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // æ·»åŠ åˆ°é¡µé¢
    document.body.appendChild(notification);
    
    // 3ç§’åè‡ªåŠ¨ç§»é™¤
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 3000);
}

// ç¼–è¾‘ä»»åŠ¡
function editSession(sessionId) {
    fetch(`/api/get_session/${sessionId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const session = data.session;
                
                // å¡«å……è¡¨å•
                document.getElementById('editSessionId').value = sessionId;
                document.getElementById('editTaskName').value = session.task;
                document.getElementById('editCategory').value = session.category;
                document.getElementById('editStartDate').value = session.start_date;
                document.getElementById('editStartTime').value = session.start_time;
                document.getElementById('editEndDate').value = session.end_date || '';
                document.getElementById('editEndTime').value = session.end_time || '';
                
                // æ›´æ–°æ¨¡æ€æ¡†æ ‡é¢˜
                document.getElementById('editModalTitle').textContent = 'ç¼–è¾‘ä»»åŠ¡';
                
                // æ˜¾ç¤ºæ¨¡æ€æ¡†
                const modal = new bootstrap.Modal(document.getElementById('editSessionModal'));
                modal.show();
            } else {
                showNotification('âŒ è·å–ä»»åŠ¡ä¿¡æ¯å¤±è´¥: ' + data.message, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('âŒ ç½‘ç»œé”™è¯¯', 'error');
        });
}

// åˆ›å»ºæ–°ä»»åŠ¡
function createNewSession() {
    // æ¸…ç©ºè¡¨å•
    document.getElementById('editSessionForm').reset();
    document.getElementById('editSessionId').value = '';
    
    // è®¾ç½®é»˜è®¤å€¼
    const now = new Date();
    const today = now.toISOString().split('T')[0];
    const currentTime = now.toTimeString().slice(0, 5);
    
    document.getElementById('editStartDate').value = today;
    document.getElementById('editStartTime').value = currentTime;
    document.getElementById('editCategory').value = 'study';
    
    // æ›´æ–°æ¨¡æ€æ¡†æ ‡é¢˜
    document.getElementById('editModalTitle').textContent = 'æ–°å»ºä»»åŠ¡';
    
    // æ˜¾ç¤ºæ¨¡æ€æ¡†
    const modal = new bootstrap.Modal(document.getElementById('editSessionModal'));
    modal.show();
}

// ä¿å­˜ä»»åŠ¡
function saveSession() {
    const sessionId = document.getElementById('editSessionId').value;
    const isNewSession = sessionId === '';
    
    const formData = {
        task: document.getElementById('editTaskName').value,
        category: document.getElementById('editCategory').value,
        start_date: document.getElementById('editStartDate').value,
        start_time: document.getElementById('editStartTime').value,
        end_date: document.getElementById('editEndDate').value,
        end_time: document.getElementById('editEndTime').value
    };
    
    // éªŒè¯è¡¨å•
    if (!formData.task || !formData.category || !formData.start_date || !formData.start_time) {
        showNotification('âŒ è¯·å¡«å†™æ‰€æœ‰å¿…éœ€å­—æ®µ', 'error');
        return;
    }
    
    const saveBtn = document.getElementById('saveSessionBtn');
    const originalText = saveBtn.innerHTML;
    saveBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> ä¿å­˜ä¸­...';
    saveBtn.disabled = true;
    
    const url = isNewSession ? '/api/create_session' : `/api/update_session/${sessionId}`;
    
    fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('âœ… ' + data.message, 'success');
            
            // éšè—æ¨¡æ€æ¡†
            const modal = bootstrap.Modal.getInstance(document.getElementById('editSessionModal'));
            modal.hide();
            
            // åˆ·æ–°é¡µé¢
            setTimeout(() => {
                location.reload();
            }, 1000);
        } else {
            showNotification('âŒ ä¿å­˜å¤±è´¥: ' + data.message, 'error');
        }
        
        saveBtn.innerHTML = originalText;
        saveBtn.disabled = false;
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('âŒ ç½‘ç»œé”™è¯¯', 'error');
        saveBtn.innerHTML = originalText;
        saveBtn.disabled = false;
    });
}

// åˆ é™¤ä»»åŠ¡
function deleteSession(sessionId) {
    const confirmed = confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä»»åŠ¡å—ï¼Ÿ\n\nåˆ é™¤åå°†æ— æ³•æ¢å¤ï¼');
    
    if (confirmed) {
        fetch(`/api/delete_session/${sessionId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('âœ… ' + data.message, 'success');
                setTimeout(() => {
                    location.reload();
                }, 1000);
            } else {
                showNotification('âŒ åˆ é™¤å¤±è´¥: ' + data.message, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('âŒ ç½‘ç»œé”™è¯¯', 'error');
        });
    }
}
</script>
{% endblock %}
