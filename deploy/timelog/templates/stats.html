{% extends "base.html" %}

{% block title %}ç»Ÿè®¡åˆ†æ - TimeLog{% endblock %}

{% block content %}
<div class="row">
    <!-- æ—¶é—´èŒƒå›´é€‰æ‹© -->
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-graph-up"></i> ç»Ÿè®¡åˆ†æ
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <label for="statsPeriod" class="form-label">ç»Ÿè®¡å‘¨æœŸ</label>
                        <select class="form-select" id="statsPeriod" onchange="updatePeriod()">
                            <option value="today"{% if selected_days == 'today' %} selected{% endif %}>ä»Šå¤©</option>
                            <option value="7"{% if selected_days == 7 %} selected{% endif %}>æœ€è¿‘7å¤©</option>
                            <option value="14"{% if selected_days == 14 %} selected{% endif %}>æœ€è¿‘14å¤©</option>
                            <option value="30"{% if selected_days == 30 %} selected{% endif %}>æœ€è¿‘30å¤©</option>
                            <option value="90"{% if selected_days == 90 %} selected{% endif %}>æœ€è¿‘90å¤©</option>
                        </select>
                    </div>
                    <div class="col-md-6 d-flex align-items-end">
                        <div class="btn-group" role="group">
                            <button class="btn btn-primary" onclick="refreshStats()">
                                <i class="bi bi-arrow-clockwise"></i> åˆ·æ–°æ•°æ®
                            </button>
                            <button class="btn btn-outline-danger" onclick="confirmClearData()" title="æ¸…ç©ºæ‰€æœ‰å†å²æ•°æ®">
                                <i class="bi bi-trash"></i> æ¸…ç©ºæ•°æ®
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ€»ä½“ç»Ÿè®¡å¡ç‰‡ -->
    <div class="col-lg-3 col-md-6 mb-4">
        <div class="card bg-success bg-opacity-10 border-success h-100">
            <div class="card-body text-center">
                <i class="bi bi-book display-4 text-success"></i>
                <h6 class="card-title mt-3">å­¦ä¹ æ€»æ—¶é—´</h6>
                <h3 class="text-success" id="totalStudyHours">{{ "%.1f"|format(recent_stats.total_study) }}h</h3>
                {% if selected_days == 'today' %}
                <p class="text-muted mb-0">ä»Šæ—¥å­¦ä¹ æ—¶é—´</p>
                {% else %}
                <p class="text-muted mb-0">å¹³å‡æ¯å¤© {{ "%.1f"|format(recent_stats.total_study / selected_days) }}h</p>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-lg-3 col-md-6 mb-4">
        <div class="card bg-warning bg-opacity-10 border-warning h-100">
            <div class="card-body text-center">
                <i class="bi bi-controller display-4 text-warning"></i>
                <h6 class="card-title mt-3">æ¸¸æˆæ€»æ—¶é—´</h6>
                <h3 class="text-warning" id="totalGameHours">{{ "%.1f"|format(recent_stats.total_game) }}h</h3>
                {% if selected_days == 'today' %}
                <p class="text-muted mb-0">ä»Šæ—¥æ¸¸æˆæ—¶é—´</p>
                {% else %}
                <p class="text-muted mb-0">å¹³å‡æ¯å¤© {{ "%.1f"|format(recent_stats.total_game / selected_days) }}h</p>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-lg-3 col-md-6 mb-4">
        <div class="card bg-info bg-opacity-10 border-info h-100">
            <div class="card-body text-center">
                <i class="bi bi-list-task display-4 text-info"></i>
                <h6 class="card-title mt-3">å…¶ä»–æ€»æ—¶é—´</h6>
                <h3 class="text-info" id="totalOtherHours">{{ "%.1f"|format(recent_stats.total_other) }}h</h3>
                {% if selected_days == 'today' %}
                <p class="text-muted mb-0">ä»Šæ—¥å…¶ä»–æ—¶é—´</p>
                {% else %}
                <p class="text-muted mb-0">å¹³å‡æ¯å¤© {{ "%.1f"|format(recent_stats.total_other / selected_days) }}h</p>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-lg-3 col-md-6 mb-4">
        <div class="card bg-primary bg-opacity-10 border-primary h-100">
            <div class="card-body text-center">
                <i class="bi bi-clock display-4 text-primary"></i>
                <h6 class="card-title mt-3">æ€»è®¡æ—¶é—´</h6>
                {% set total_time = recent_stats.total_study + recent_stats.total_game + recent_stats.total_other %}
                <h3 class="text-primary" id="totalHours">{{ "%.1f"|format(total_time) }}h</h3>
                {% if selected_days == 'today' %}
                <p class="text-muted mb-0">ä»Šæ—¥æ€»æ—¶é—´</p>
                {% else %}
                <p class="text-muted mb-0">å¹³å‡æ¯å¤© {{ "%.1f"|format(total_time / selected_days) }}h</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- æ—¶é—´åˆ†å¸ƒé¥¼å›¾ -->
    <div class="col-lg-6 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-pie-chart"></i> æ—¶é—´åˆ†å¸ƒ
                </h5>
            </div>
            <div class="card-body">
                <canvas id="distributionChart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>

    <!-- æ¯æ—¥è¶‹åŠ¿å›¾ -->
    <div class="col-lg-6 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-graph-up"></i> æ¯æ—¥è¶‹åŠ¿
                </h5>
            </div>
            <div class="card-body">
                <canvas id="trendChart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>

    <!-- å­¦ä¹ æ•ˆç‡åˆ†æ -->
    {% set total_time = recent_stats.total_study + recent_stats.total_game + recent_stats.total_other %}
    {% if total_time > 0 %}
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-speedometer2"></i> å­¦ä¹ æ•ˆç‡åˆ†æ
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span>å­¦ä¹ æ—¶é—´å æ¯”</span>
                            <span class="fw-bold text-success">{{ "%.1f"|format((recent_stats.total_study / total_time * 100)) }}%</span>
                        </div>
                        <div class="progress mb-3" style="height: 20px;">
                            <div class="progress-bar bg-success" role="progressbar" 
                                 style="width: {{ (recent_stats.total_study / total_time * 100) }}%">
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span>æ¸¸æˆæ—¶é—´å æ¯”</span>
                            <span class="fw-bold text-warning">{{ "%.1f"|format((recent_stats.total_game / total_time * 100)) }}%</span>
                        </div>
                        <div class="progress mb-3" style="height: 20px;">
                            <div class="progress-bar bg-warning" role="progressbar" 
                                 style="width: {{ (recent_stats.total_game / total_time * 100) }}%">
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span>å…¶ä»–æ—¶é—´å æ¯”</span>
                            <span class="fw-bold text-info">{{ "%.1f"|format((recent_stats.total_other / total_time * 100)) }}%</span>
                        </div>
                        <div class="progress mb-3" style="height: 20px;">
                            <div class="progress-bar bg-info" role="progressbar" 
                                 style="width: {{ (recent_stats.total_other / total_time * 100) }}%">
                            </div>
                        </div>
                    </div>
                </div>
                
                <hr>
                
                <div class="row text-center">
                    <div class="col-md-3">
                        <h6 class="text-muted">å­¦ä¹ /æ¸¸æˆæ¯”ä¾‹</h6>
                        <h4 class="text-success">{{ "%.1f"|format((recent_stats.total_study / recent_stats.total_game)) if recent_stats.total_game > 0 else "âˆ" }}:1</h4>
                    </div>
                    <div class="col-md-3">
                        <h6 class="text-muted">å­¦ä¹ æ•ˆç‡</h6>
                        {% set productive_time = recent_stats.total_study + recent_stats.total_game %}
                        <h4 class="text-success">{{ "%.1f"|format((recent_stats.total_study / productive_time * 100)) if productive_time > 0 else "0" }}%</h4>
                        <small class="text-muted">å­¦ä¹ /(å­¦ä¹ +æ¸¸æˆ)</small>
                    </div>
                    <div class="col-md-3">
                        <h6 class="text-muted">æœ€é«˜å•æ—¥å­¦ä¹ </h6>
                        <h4 class="text-primary" id="maxDailyStudy">{{ "%.1f"|format(recent_stats.max_daily_study) }}h</h4>
                    </div>
                    <div class="col-md-3">
                        <h6 class="text-muted">æ´»è·ƒå¤©æ•°</h6>
                        <h4 class="text-info" id="activeDays">{{ recent_stats.active_days }}å¤©</h4>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- è¯¦ç»†æ¯æ—¥ç»Ÿè®¡è¡¨æ ¼ -->
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-calendar3"></i> æ¯æ—¥è¯¦ç»†ç»Ÿè®¡
                </h5>
            </div>
            <div class="card-body">
                {% if recent_stats.daily_stats %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>æ—¥æœŸ</th>
                                <th>ğŸ“š å­¦ä¹ </th>
                                <th>ğŸ® æ¸¸æˆ</th>
                                <th>ğŸ“‹ å…¶ä»–</th>
                                <th>æ€»è®¡</th>
                                <th>å­¦ä¹ å æ¯”</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for date, stats in recent_stats.daily_stats.items() %}
                            {% set daily_total = stats.study + stats.game + stats.other %}
                            <tr>
                                <td>
                                    <strong>{{ date }}</strong>
                                    {% if date == "ä»Šå¤©" %}
                                    <span class="badge bg-primary ms-1">ä»Šå¤©</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="text-success fw-bold">{{ "%.1f"|format(stats.study) }}h</span>
                                </td>
                                <td>
                                    <span class="text-warning fw-bold">{{ "%.1f"|format(stats.game) }}h</span>
                                </td>
                                <td>
                                    <span class="text-info fw-bold">{{ "%.1f"|format(stats.other) }}h</span>
                                </td>
                                <td>
                                    <span class="text-primary fw-bold">{{ "%.1f"|format(daily_total) }}h</span>
                                </td>
                                <td>
                                    {% if daily_total > 0 %}
                                    <span class="text-success">{{ "%.0f"|format((stats.study / daily_total * 100)) }}%</span>
                                    {% else %}
                                    <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="bi bi-graph-down display-4 text-muted"></i>
                    <h4 class="mt-3 text-muted">æš‚æ— ç»Ÿè®¡æ•°æ®</h4>
                    <p class="text-muted">å¼€å§‹è®°å½•æ—¶é—´æ¥æŸ¥çœ‹ç»Ÿè®¡ä¿¡æ¯</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// é¡µé¢åŠ è½½ååˆå§‹åŒ–å›¾è¡¨
document.addEventListener('DOMContentLoaded', function() {
    updateNavbarStatus();
    initCharts();
});

// åˆå§‹åŒ–å›¾è¡¨
function initCharts() {
    // æ—¶é—´åˆ†å¸ƒé¥¼å›¾
    const distributionCtx = document.getElementById('distributionChart').getContext('2d');
    const studyHours = {{ recent_stats.total_study }};
    const gameHours = {{ recent_stats.total_game }};
    const otherHours = {{ recent_stats.total_other }};
    
    new Chart(distributionCtx, {
        type: 'doughnut',
        data: {
            labels: ['ğŸ“š å­¦ä¹ ', 'ğŸ® æ¸¸æˆ', 'ğŸ“‹ å…¶ä»–'],
            datasets: [{
                data: [studyHours, gameHours, otherHours],
                backgroundColor: [
                    'rgba(25, 135, 84, 0.8)',
                    'rgba(255, 193, 7, 0.8)',
                    'rgba(13, 202, 240, 0.8)'
                ],
                borderColor: [
                    'rgb(25, 135, 84)',
                    'rgb(255, 193, 7)',
                    'rgb(13, 202, 240)'
                ],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label;
                            const value = context.parsed;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : '0';
                            return `${label}: ${value.toFixed(1)}h (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });

    // æ¯æ—¥è¶‹åŠ¿å›¾
    const trendCtx = document.getElementById('trendChart').getContext('2d');
    
    // æ ¹æ®æ˜¯å¦æ˜¯"ä»Šå¤©"é€‰é¡¹å†³å®šä½¿ç”¨å“ªä¸ªæ•°æ®æº
    {% if selected_days == 'today' and trend_stats %}
    const dailyStats = {{ trend_stats.daily_stats | tojson }};
    {% else %}
    const dailyStats = {{ recent_stats.daily_stats | tojson }};
    {% endif %}
    
    // å¤„ç†æ•°æ® - ç¡®ä¿æ­£ç¡®çš„æ—¶é—´é¡ºåºï¼ˆæœ€æ—©åˆ°æœ€æ–°ï¼‰
    const allDates = Object.keys(dailyStats);
    
    // è‡ªå®šä¹‰æ’åºå‡½æ•°ï¼Œç¡®ä¿æ—¥æœŸæŒ‰æ­£ç¡®é¡ºåºæ’åˆ—
    const dates = allDates.sort((a, b) => {
        // "ä»Šå¤©"åº”è¯¥åœ¨æœ€å
        if (a === "ä»Šå¤©") return 1;
        if (b === "ä»Šå¤©") return -1;
        
        // "æ˜¨å¤©"åº”è¯¥åœ¨å€’æ•°ç¬¬äºŒ
        if (a === "æ˜¨å¤©") return 1;
        if (b === "æ˜¨å¤©") return -1;
        
        // å…¶ä»–æ—¥æœŸæŒ‰å­—ç¬¦ä¸²æ’åºï¼ˆMM-DDæ ¼å¼ï¼‰
        return a.localeCompare(b);
    });
    
    const studyData = dates.map(date => dailyStats[date].study);
    const gameData = dates.map(date => dailyStats[date].game);
    const otherData = dates.map(date => dailyStats[date].other);
    
    new Chart(trendCtx, {
        type: 'line',
        data: {
            labels: dates,
            datasets: [{
                label: 'ğŸ“š å­¦ä¹ ',
                data: studyData,
                borderColor: 'rgb(25, 135, 84)',
                backgroundColor: 'rgba(25, 135, 84, 0.1)',
                tension: 0.4
            }, {
                label: 'ğŸ® æ¸¸æˆ',
                data: gameData,
                borderColor: 'rgb(255, 193, 7)',
                backgroundColor: 'rgba(255, 193, 7, 0.1)',
                tension: 0.4
            }, {
                label: 'ğŸ“‹ å…¶ä»–',
                data: otherData,
                borderColor: 'rgb(13, 202, 240)',
                backgroundColor: 'rgba(13, 202, 240, 0.1)',
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'æ—¶é—´ (å°æ—¶)'
                    }
                }
            },
            plugins: {
                legend: {
                    position: 'bottom'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `${context.dataset.label}: ${context.parsed.y.toFixed(1)}h`;
                        }
                    }
                }
            }
        }
    });
}

// æ›´æ–°ç»Ÿè®¡å‘¨æœŸ
function updatePeriod() {
    const period = document.getElementById('statsPeriod').value;
    // è¿™é‡Œå¯ä»¥æ·»åŠ AJAXè¯·æ±‚æ¥è·å–æ–°çš„ç»Ÿè®¡æ•°æ®
    // æš‚æ—¶åªåˆ·æ–°é¡µé¢
    window.location.href = `/stats?days=${period}`;
}

// åˆ·æ–°ç»Ÿè®¡æ•°æ®
function refreshStats() {
    location.reload();
}

// ç¡®è®¤æ¸…ç©ºæ•°æ®
function confirmClearData() {
    const confirmed = confirm(
        'âš ï¸ è­¦å‘Šï¼šæ­¤æ“ä½œå°†æ°¸ä¹…åˆ é™¤æ‰€æœ‰å†å²æ•°æ®ï¼\n\n' +
        'åŒ…æ‹¬ï¼š\n' +
        'â€¢ æ‰€æœ‰ä»»åŠ¡è®°å½•\n' +
        'â€¢ æ‰€æœ‰ç»Ÿè®¡æ•°æ®\n' +
        'â€¢ å½“å‰æ­£åœ¨è¿›è¡Œçš„ä»»åŠ¡\n\n' +
        'æ­¤æ“ä½œæ— æ³•æ’¤é”€ï¼Œç¡®å®šè¦ç»§ç»­å—ï¼Ÿ'
    );
    
    if (confirmed) {
        const doubleConfirm = confirm(
            'ğŸ”´ æœ€åç¡®è®¤ï¼šæ‚¨çœŸçš„è¦åˆ é™¤æ‰€æœ‰æ•°æ®å—ï¼Ÿ\n\n' +
            'åˆ é™¤åå°†æ— æ³•æ¢å¤ï¼'
        );
        
        if (doubleConfirm) {
            clearAllData();
        }
    }
}

// æ‰§è¡Œæ¸…ç©ºæ•°æ®
function clearAllData() {
    const clearBtn = event.target;
    const originalText = clearBtn.innerHTML;
    clearBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> æ¸…ç©ºä¸­...';
    clearBtn.disabled = true;
    
    fetch('/api/clear_data', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('âœ… ' + data.message, 'success');
            setTimeout(() => {
                location.reload();
            }, 1500);
        } else {
            showNotification('âŒ æ¸…ç©ºå¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'), 'error');
            clearBtn.innerHTML = originalText;
            clearBtn.disabled = false;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('âŒ æ¸…ç©ºå¤±è´¥: ç½‘ç»œé”™è¯¯', 'error');
        clearBtn.innerHTML = originalText;
        clearBtn.disabled = false;
    });
}

// æ˜¾ç¤ºé€šçŸ¥æ¶ˆæ¯
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 1050; min-width: 300px;';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 3000);
}
</script>
{% endblock %}
