{% extends "base.html" %}

{% block title %}ä»»åŠ¡ç®¡ç† - TimeLog{% endblock %}

{% block content %}
<div class="row">
    <!-- å½“å‰ä»»åŠ¡çŠ¶æ€ -->
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-activity"></i> å½“å‰ä»»åŠ¡
                </h5>
            </div>
            <div class="card-body">
                <div id="current-task-display">
                    {% if current_session %}
                    <div class="alert alert-success">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="alert-heading">
                                    <i class="bi bi-play-circle-fill"></i> æ­£åœ¨è¿›è¡Œ
                                </h6>
                                <p class="mb-1"><strong>{{ current_session.task }}</strong></p>
                                <p class="mb-1">
                                    {% if current_session.category == 'study' %}
                                        <span class="badge bg-success">ğŸ“š å­¦ä¹ </span>
                                    {% elif current_session.category == 'game' %}
                                        <span class="badge bg-warning">ğŸ® æ¸¸æˆ</span>
                                    {% else %}
                                        <span class="badge bg-info">ğŸ“‹ å…¶ä»–</span>
                                    {% endif %}
                                </p>
                                <p class="mb-0">
                                    <small class="text-muted">
                                        å¼€å§‹äº {{ current_session.start_time }} | 
                                        å·²è¿›è¡Œ <span id="duration-display">{{ current_session.duration }}</span> åˆ†é’Ÿ
                                    </small>
                                </p>
                            </div>
                            <button class="btn btn-danger btn-sm" onclick="stopCurrentTask()">
                                <i class="bi bi-stop-circle"></i> ç»“æŸ
                            </button>
                        </div>
                    </div>
                    {% else %}
                    <div class="alert alert-secondary">
                        <h6 class="alert-heading">
                            <i class="bi bi-pause-circle"></i> ç©ºé—²çŠ¶æ€
                        </h6>
                        <p class="mb-0">å½“å‰æ²¡æœ‰æ­£åœ¨è¿›è¡Œçš„ä»»åŠ¡</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- å¼€å§‹æ–°ä»»åŠ¡ -->
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-plus-circle"></i> å¼€å§‹æ–°ä»»åŠ¡
                </h5>
            </div>
            <div class="card-body">
                <form id="start-task-form">
                    <div class="mb-3">
                        <label for="task-name" class="form-label">ä»»åŠ¡åç§°</label>
                        <input type="text" class="form-control" id="task-name" 
                               placeholder="ä¾‹å¦‚ï¼šå¤ä¹ çº¿æ€§ä»£æ•°" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="task-category" class="form-label">ä»»åŠ¡ç±»åˆ«</label>
                        <select class="form-select" id="task-category">
                            <option value="study" selected>ğŸ“š å­¦ä¹ </option>
                            <option value="game">ğŸ® æ¸¸æˆ</option>
                            <option value="other">ğŸ“‹ å…¶ä»–</option>
                        </select>
                    </div>
                    
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-play-fill"></i> å¼€å§‹ä»»åŠ¡
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- å¿«é€Ÿå¼€å§‹æ¨¡æ¿ -->
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-lightning-fill"></i> å¿«é€Ÿå¼€å§‹
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <!-- å­¦ä¹ ä»»åŠ¡æ¨¡æ¿ -->
                    <div class="col-md-4 mb-3">
                        <h6 class="text-success">ğŸ“š å­¦ä¹ ä»»åŠ¡</h6>
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-success btn-sm" 
                                    onclick="quickStart('å¤ä¹ æ•°å­¦', 'study')">å¤ä¹ æ•°å­¦</button>
                            <button class="btn btn-outline-success btn-sm" 
                                    onclick="quickStart('èƒŒè‹±è¯­å•è¯', 'study')">èƒŒè‹±è¯­å•è¯</button>
                            <button class="btn btn-outline-success btn-sm" 
                                    onclick="quickStart('ç¼–ç¨‹ç»ƒä¹ ', 'study')">ç¼–ç¨‹ç»ƒä¹ </button>
                            <button class="btn btn-outline-success btn-sm" 
                                    onclick="quickStart('é˜…è¯»ä¸“ä¸šä¹¦ç±', 'study')">é˜…è¯»ä¸“ä¸šä¹¦ç±</button>
                        </div>
                    </div>
                    
                    <!-- æ¸¸æˆå¨±ä¹æ¨¡æ¿ -->
                    <div class="col-md-4 mb-3">
                        <h6 class="text-warning">ğŸ® æ¸¸æˆå¨±ä¹</h6>
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-warning btn-sm" 
                                    onclick="quickStart('ä¸‰è§’æ´²è¡ŒåŠ¨', 'game')">ä¸‰è§’æ´²è¡ŒåŠ¨</button>
                            <button class="btn btn-outline-warning btn-sm" 
                                    onclick="quickStart('åŸç¥', 'game')">åŸç¥</button>
                            <button class="btn btn-outline-warning btn-sm" 
                                    onclick="quickStart('Steamæ¸¸æˆ', 'game')">Steamæ¸¸æˆ</button>
                            <button class="btn btn-outline-warning btn-sm" 
                                    onclick="quickStart('çœ‹è§†é¢‘', 'game')">çœ‹è§†é¢‘</button>
                        </div>
                    </div>
                    
                    <!-- å…¶ä»–æ´»åŠ¨æ¨¡æ¿ -->
                    <div class="col-md-4 mb-3">
                        <h6 class="text-info">ğŸ“‹ å…¶ä»–æ´»åŠ¨</h6>
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-info btn-sm" 
                                    onclick="quickStart('è¿åŠ¨å¥èº«', 'other')">è¿åŠ¨å¥èº«</button>
                            <button class="btn btn-outline-info btn-sm" 
                                    onclick="quickStart('æ•´ç†æˆ¿é—´', 'other')">æ•´ç†æˆ¿é—´</button>
                            <button class="btn btn-outline-info btn-sm" 
                                    onclick="quickStart('ç¤¾äº¤èŠå¤©', 'other')">ç¤¾äº¤èŠå¤©</button>
                            <button class="btn btn-outline-info btn-sm" 
                                    onclick="quickStart('è´­ç‰©', 'other')">è´­ç‰©</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// å¼€å§‹ä»»åŠ¡è¡¨å•å¤„ç†
document.getElementById('start-task-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const taskName = document.getElementById('task-name').value.trim();
    const category = document.getElementById('task-category').value;
    
    if (!taskName) {
        showToast('è¯·è¾“å…¥ä»»åŠ¡åç§°', 'warning');
        return;
    }
    
    startTask(taskName, category);
});

// å¼€å§‹ä»»åŠ¡å‡½æ•°
function startTask(taskName, category) {
    fetch('/api/start_task', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            task: taskName,
            category: category
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(data.message, 'success');
            // æ¸…ç©ºè¡¨å•
            document.getElementById('task-name').value = '';
            document.getElementById('task-category').value = 'study';
            // åˆ·æ–°é¡µé¢æ˜¾ç¤º
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast(data.message, 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•', 'danger');
    });
}

// åœæ­¢å½“å‰ä»»åŠ¡
function stopCurrentTask() {
    if (confirm('ç¡®å®šè¦ç»“æŸå½“å‰ä»»åŠ¡å—ï¼Ÿ')) {
        fetch('/api/stop_task', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast(`${data.message}ï¼ŒæŒç»­ ${data.duration} åˆ†é’Ÿ`, 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast(data.message, 'warning');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•', 'danger');
        });
    }
}

// å¿«é€Ÿå¼€å§‹ä»»åŠ¡
function quickStart(taskName, category) {
    startTask(taskName, category);
}

// æ›´æ–°æŒç»­æ—¶é—´æ˜¾ç¤º
{% if current_session %}
let startTime = new Date('{{ current_session.start_time }}');
setInterval(function() {
    const now = new Date();
    const duration = Math.floor((now - startTime) / 60000); // åˆ†é’Ÿ
    document.getElementById('duration-display').textContent = duration;
}, 60000); // æ¯åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡
{% endif %}

// é¡µé¢åŠ è½½æ—¶æ›´æ–°å¯¼èˆªæ çŠ¶æ€
document.addEventListener('DOMContentLoaded', function() {
    updateNavbarStatus();
});
</script>
{% endblock %}
