{% extends "base.html" %}

{% block title %}ÂéÜÂè≤ËÆ∞ÂΩï - TimeLog{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="bi bi-journal"></i> ÂéÜÂè≤ËÆ∞ÂΩï
                </h5>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="filterByCategory('all')">
                        ÂÖ®ÈÉ®
                    </button>
                    <button type="button" class="btn btn-outline-success btn-sm" onclick="filterByCategory('study')">
                        üìö Â≠¶‰π†
                    </button>
                    <button type="button" class="btn btn-outline-warning btn-sm" onclick="filterByCategory('game')">
                        üéÆ Ê∏∏Êàè
                    </button>
                    <button type="button" class="btn btn-outline-info btn-sm" onclick="filterByCategory('other')">
                        üìã ÂÖ∂‰ªñ
                    </button>
                </div>
            </div>
            <div class="card-body">
                {% if sessions %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th width="10%">ÂºÄÂßãÊó•Êúü</th>
                                <th width="10%">ÂºÄÂßãÊó∂Èó¥</th>
                                <th width="10%">ÁªìÊùüÊó•Êúü</th>
                                <th width="10%">ÁªìÊùüÊó∂Èó¥</th>
                                <th width="28%">‰ªªÂä°</th>
                                <th width="8%">Á±ªÂà´</th>
                                <th width="8%">Êó∂Èïø</th>
                                <th width="16%">Êìç‰Ωú</th>
                            </tr>
                        </thead>
                        <tbody id="historyTable">
                            {% for session in sessions %}
                            <tr class="session-row" data-category="{{ session.category }}">
                                <td>
                                    <span class="text-muted">
                                        {{ session.date }}
                                    </span>
                                </td>
                                <td>
                                    <small class="text-primary">
                                        <i class="bi bi-play-circle"></i>
                                        {{ session.start_time }}
                                    </small>
                                </td>
                                <td>
                                    {% if session.end_date %}
                                    <span class="text-muted">
                                        {% if session.end_date != session.date %}
                                        <span class="badge bg-warning text-dark">
                                            {{ session.end_date }}
                                        </span>
                                        {% else %}
                                        {{ session.end_date }}
                                        {% endif %}
                                    </span>
                                    {% else %}
                                    <small class="text-warning">
                                        ËøõË°å‰∏≠
                                    </small>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if session.end_time %}
                                    <small class="text-danger">
                                        <i class="bi bi-stop-circle"></i>
                                        {{ session.end_time }}
                                    </small>
                                    {% else %}
                                    <small class="text-warning">
                                        <i class="bi bi-clock"></i>
                                        --:--
                                    </small>
                                    {% endif %}
                                </td>
                                <td>
                                    <strong>{{ session.task }}</strong>
                                </td>
                                <td>
                                    {% if session.category == 'study' %}
                                        <span class="badge bg-success">üìö Â≠¶‰π†</span>
                                    {% elif session.category == 'game' %}
                                        <span class="badge bg-warning">üéÆ Ê∏∏Êàè</span>
                                    {% elif session.category == 'other' %}
                                        <span class="badge bg-info">üìã ÂÖ∂‰ªñ</span>
                                    {% else %}
                                        <span class="badge bg-secondary">{{ session.category }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if session.duration_hours %}
                                    <span class="fw-bold text-primary">
                                        {{ "%.1f"|format(session.duration_hours) }}h
                                    </span>
                                    {% else %}
                                    <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button class="btn btn-outline-primary btn-sm" 
                                                onclick="editSession({{ session.original_index }})" 
                                                title="ÁºñËæë‰ªªÂä°">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button class="btn btn-outline-danger btn-sm" 
                                                onclick="deleteSession({{ session.original_index }})" 
                                                title="Âà†Èô§‰ªªÂä°">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <!-- ÂàÜÈ°µ‰ø°ÊÅØ -->
                <div class="row mt-3">
                    <div class="col-sm-6">
                        <p class="text-muted mb-0">
                            ÊòæÁ§∫ {{ sessions|length }} Êù°ËÆ∞ÂΩï
                        </p>
                    </div>
                    <div class="col-sm-6 text-end">
                        <div class="btn-group" role="group">
                            <button class="btn btn-success btn-sm" onclick="createNewSession()" title="ÂàõÂª∫Êñ∞‰ªªÂä°">
                                <i class="bi bi-plus-circle"></i> Êñ∞Âª∫‰ªªÂä°
                            </button>
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-outline-primary btn-sm dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="bi bi-download"></i> ÂØºÂá∫Êï∞ÊçÆ
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" onclick="exportData('csv-utf8')">
                                        <i class="bi bi-file-earmark-spreadsheet"></i> CSV (UTF-8+BOM)
                                    </a></li>
                                    <li><a class="dropdown-item" href="#" onclick="exportDataServer('csv', 'gbk')">
                                        <i class="bi bi-file-earmark-spreadsheet"></i> CSV (GBKÔºåÂÖºÂÆπExcel)
                                    </a></li>
                                    <li><a class="dropdown-item" href="#" onclick="exportDataServer('json', 'utf-8')">
                                        <i class="bi bi-file-earmark-code"></i> JSON
                                    </a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item" href="#" onclick="exportData('csv-gbk')">
                                        <i class="bi bi-file-earmark-spreadsheet"></i> CSV (ÂâçÁ´ØÁîüÊàê)
                                    </a></li>
                                </ul>
                            </div>
                            <button class="btn btn-outline-danger btn-sm" onclick="confirmClearData()" title="Ê∏ÖÁ©∫ÊâÄÊúâÂéÜÂè≤Êï∞ÊçÆ">
                                <i class="bi bi-trash"></i> Ê∏ÖÁ©∫ÂéÜÂè≤
                            </button>
                        </div>
                    </div>
                </div>
                
                {% else %}
                <div class="text-center py-5">
                    <i class="bi bi-journal-x display-4 text-muted"></i>
                    <h4 class="mt-3 text-muted">ÊöÇÊó†ÂéÜÂè≤ËÆ∞ÂΩï</h4>
                    <p class="text-muted">ÂºÄÂßãËÆ∞ÂΩïÊÇ®ÁöÑÁ¨¨‰∏Ä‰∏™‰ªªÂä°ÂêßÔºÅ</p>
                    <a href="{{ url_for('tasks') }}" class="btn btn-primary">
                        <i class="bi bi-plus-circle"></i> ÂºÄÂßã‰ªªÂä°
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- ÁªüËÆ°ÊëòË¶ÅÂç°Áâá -->
{% if sessions %}
<div class="row mt-4">
    <div class="col-md-3 mb-3">
        <div class="card bg-success bg-opacity-10 border-success">
            <div class="card-body text-center">
                <i class="bi bi-book display-6 text-success"></i>
                <h6 class="card-title mt-2">Â≠¶‰π†ÊÄªÊó∂Èó¥</h6>
                <h4 class="text-success" id="totalStudyTime">-</h4>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card bg-warning bg-opacity-10 border-warning">
            <div class="card-body text-center">
                <i class="bi bi-controller display-6 text-warning"></i>
                <h6 class="card-title mt-2">Ê∏∏ÊàèÊÄªÊó∂Èó¥</h6>
                <h4 class="text-warning" id="totalGameTime">-</h4>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card bg-info bg-opacity-10 border-info">
            <div class="card-body text-center">
                <i class="bi bi-list-task display-6 text-info"></i>
                <h6 class="card-title mt-2">ÂÖ∂‰ªñÊÄªÊó∂Èó¥</h6>
                <h4 class="text-info" id="totalOtherTime">-</h4>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card bg-primary bg-opacity-10 border-primary">
            <div class="card-body text-center">
                <i class="bi bi-clock display-6 text-primary"></i>
                <h6 class="card-title mt-2">ÊÄªËÆ°Êó∂Èó¥</h6>
                <h4 class="text-primary" id="totalTime">-</h4>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- ÁºñËæë‰ªªÂä°Ê®°ÊÄÅÊ°Ü -->
<div class="modal fade" id="editSessionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editModalTitle">ÁºñËæë‰ªªÂä°</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editSessionForm">
                    <input type="hidden" id="editSessionId">
                    
                    <div class="mb-3">
                        <label for="editTaskName" class="form-label">‰ªªÂä°ÂêçÁß∞</label>
                        <input type="text" class="form-control" id="editTaskName" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editCategory" class="form-label">‰ªªÂä°Á±ªÂà´</label>
                        <select class="form-select" id="editCategory" required>
                            <option value="study">üìö Â≠¶‰π†</option>
                            <option value="game">üéÆ Ê∏∏Êàè</option>
                            <option value="other">üìã ÂÖ∂‰ªñ</option>
                        </select>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editStartDate" class="form-label">ÂºÄÂßãÊó•Êúü</label>
                                <input type="date" class="form-control" id="editStartDate" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editStartTime" class="form-label">ÂºÄÂßãÊó∂Èó¥</label>
                                <input type="time" class="form-control" id="editStartTime" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editEndDate" class="form-label">ÁªìÊùüÊó•Êúü</label>
                                <input type="date" class="form-control" id="editEndDate">
                                <div class="form-text">ÁïôÁ©∫Ë°®Á§∫‰ªªÂä°Ê≠£Âú®ËøõË°å‰∏≠</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editEndTime" class="form-label">ÁªìÊùüÊó∂Èó¥</label>
                                <input type="time" class="form-control" id="editEndTime">
                                <div class="form-text">ÊîØÊåÅË∑®Â§©‰ªªÂä°</div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ÂèñÊ∂à</button>
                <button type="button" class="btn btn-primary" id="saveSessionBtn" onclick="saveSession()">‰øùÂ≠ò</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// È°µÈù¢Âä†ËΩΩÂêéËÆ°ÁÆóÁªüËÆ°
document.addEventListener('DOMContentLoaded', function() {
    updateNavbarStatus();
    calculateTotals();
});

// ÊåâÂàÜÁ±ªÁ≠õÈÄâ
function filterByCategory(category) {
    const rows = document.querySelectorAll('.session-row');
    const buttons = document.querySelectorAll('.btn-group .btn');
    
    // Êõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅ
    buttons.forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    // Á≠õÈÄâË°å
    rows.forEach(row => {
        if (category === 'all' || row.dataset.category === category) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
    
    calculateTotals();
}

// ËÆ°ÁÆóÊÄªËÆ°Êó∂Èó¥
function calculateTotals() {
    const visibleRows = document.querySelectorAll('.session-row[style=""], .session-row:not([style])');
    let studyTotal = 0, gameTotal = 0, otherTotal = 0;
    
    visibleRows.forEach(row => {
        const category = row.dataset.category;
        const durationCell = row.cells[6];  // Êó∂ÈïøÂàóÁé∞Âú®ÊòØÁ¨¨7ÂàóÔºàÁ¥¢Âºï6Ôºâ
        const durationText = durationCell.textContent.trim();
        
        if (durationText !== '-') {
            const hours = parseFloat(durationText.replace('h', ''));
            if (!isNaN(hours)) {
                switch(category) {
                    case 'study': studyTotal += hours; break;
                    case 'game': gameTotal += hours; break;
                    case 'other': otherTotal += hours; break;
                }
            }
        }
    });
    
    const totalTime = studyTotal + gameTotal + otherTotal;
    
    // Êõ¥Êñ∞ÊòæÁ§∫ÔºàÊ£ÄÊü•ÂÖÉÁ¥†ÊòØÂê¶Â≠òÂú®Ôºâ
    const studyEl = document.getElementById('totalStudyTime');
    const gameEl = document.getElementById('totalGameTime');
    const otherEl = document.getElementById('totalOtherTime');
    const totalEl = document.getElementById('totalTime');
    
    if (studyEl) studyEl.textContent = studyTotal.toFixed(1) + 'h';
    if (gameEl) gameEl.textContent = gameTotal.toFixed(1) + 'h';
    if (otherEl) otherEl.textContent = otherTotal.toFixed(1) + 'h';
    if (totalEl) totalEl.textContent = totalTime.toFixed(1) + 'h';
}

// ÂØºÂá∫Êï∞ÊçÆÂäüËÉΩ
function exportData(format = 'csv-utf8') {
    const visibleRows = document.querySelectorAll('.session-row[style=""], .session-row:not([style])');
    const data = [];
    
    // Êî∂ÈõÜÊï∞ÊçÆ
    visibleRows.forEach(row => {
        const cells = row.cells;
        const rowData = {
            startDate: cells[0].textContent.trim(),
            startTime: cells[1].textContent.trim().replace(/.*(\d{2}:\d{2}).*/, '$1'),
            endDate: cells[2].textContent.trim(),
            endTime: cells[3].textContent.trim().replace(/.*(\d{2}:\d{2}).*/, '$1'),
            task: cells[4].textContent.trim(),
            category: cells[5].textContent.trim(),
            duration: cells[6].textContent.trim()
        };
        data.push(rowData);
    });
    
    if (data.length === 0) {
        showNotification('‚ùå Ê≤°ÊúâÊï∞ÊçÆÂèØÂØºÂá∫', 'error');
        return;
    }
    
    const timestamp = new Date().toISOString().split('T')[0];
    
    if (format === 'json') {
        // JSONÊ†ºÂºèÂØºÂá∫
        const jsonData = {
            exportDate: new Date().toISOString(),
            totalRecords: data.length,
            data: data
        };
        
        const blob = new Blob([JSON.stringify(jsonData, null, 2)], { 
            type: 'application/json;charset=utf-8;' 
        });
        downloadFile(blob, `timelog_history_${timestamp}.json`);
        showNotification('‚úÖ JSONÊï∞ÊçÆÂØºÂá∫ÊàêÂäüÔºÅ', 'success');
        
    } else if (format === 'csv-gbk') {
        // GBKÁºñÁ†ÅÁöÑCSVÔºàÂÖºÂÆπExcelÔºâ
        let csvContent = "ÂºÄÂßãÊó•Êúü,ÂºÄÂßãÊó∂Èó¥,ÁªìÊùüÊó•Êúü,ÁªìÊùüÊó∂Èó¥,‰ªªÂä°,Á±ªÂà´,Êó∂Èïø(Â∞èÊó∂)\n";
        
        data.forEach(row => {
            csvContent += `"${row.startDate}","${row.startTime}","${row.endDate}","${row.endTime}","${row.task}","${row.category}","${row.duration}"\n`;
        });
        
        // Ê≥®ÊÑèÔºöÂÆûÈôÖÁöÑGBKÁºñÁ†ÅËΩ¨Êç¢Âú®ÊµèËßàÂô®‰∏≠ÊØîËæÉÂ§çÊùÇÔºåËøôÈáåÊèê‰æõ‰∏Ä‰∏™ÂèòÈÄöÊñπÊ°à
        const blob = new Blob([csvContent], { type: 'text/csv;charset=gbk;' });
        downloadFile(blob, `timelog_history_${timestamp}_gbk.csv`);
        showNotification('‚úÖ CSVÊï∞ÊçÆÂØºÂá∫ÊàêÂäüÔºÅÂ¶ÇÊûúExcel‰∏≠‰ªçÊúâ‰π±Á†ÅÔºåËØ∑Âú®Excel‰∏≠‰ΩøÁî®"Êï∞ÊçÆ"->"‰ªéÊñáÊú¨"ÂØºÂÖ•ÔºåÂπ∂ÈÄâÊã©UTF-8ÁºñÁ†Å„ÄÇ', 'success');
        
    } else {
        // UTF-8+BOMÁºñÁ†ÅÁöÑCSVÔºàÈªòËÆ§Ôºâ
        let csvContent = "ÂºÄÂßãÊó•Êúü,ÂºÄÂßãÊó∂Èó¥,ÁªìÊùüÊó•Êúü,ÁªìÊùüÊó∂Èó¥,‰ªªÂä°,Á±ªÂà´,Êó∂Èïø(Â∞èÊó∂)\n";
        
        data.forEach(row => {
            csvContent += `"${row.startDate}","${row.startTime}","${row.endDate}","${row.endTime}","${row.task}","${row.category}","${row.duration}"\n`;
        });
        
        // Ê∑ªÂä†BOM‰ª•Á°Æ‰øùExcelÊ≠£Á°ÆËØÜÂà´UTF-8ÁºñÁ†Å
        const BOM = '\uFEFF';
        const csvWithBOM = BOM + csvContent;
        
        const blob = new Blob([csvWithBOM], { type: 'text/csv;charset=utf-8;' });
        downloadFile(blob, `timelog_history_${timestamp}.csv`);
        showNotification('‚úÖ CSVÊï∞ÊçÆÂØºÂá∫ÊàêÂäüÔºÅÊ∑ªÂä†‰∫ÜBOMÊ†áËÆ∞‰ª•ÊîπÂñÑExcelÂÖºÂÆπÊÄß„ÄÇ', 'success');
    }
}

// ÈÄöÁî®Êñá‰ª∂‰∏ãËΩΩÂáΩÊï∞
function downloadFile(blob, filename) {
    const link = document.createElement("a");
    const url = URL.createObjectURL(blob);
    link.setAttribute("href", url);
    link.setAttribute("download", filename);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
}

// ÊúçÂä°Âô®Á´ØÂØºÂá∫ÔºàÊõ¥Â•ΩÁöÑ‰∏≠ÊñáÊîØÊåÅÔºâ
function exportDataServer(format = 'csv', encoding = 'utf-8') {
    const url = `/api/export_data?format=${format}&encoding=${encoding}`;
    
    // ÊòæÁ§∫Âä†ËΩΩÊèêÁ§∫
    showNotification('üì• Ê≠£Âú®ÁîüÊàêÂØºÂá∫Êñá‰ª∂...', 'info');
    
    // ÂàõÂª∫ÈöêËóèÁöÑÈìæÊé•Êù•Ëß¶Âèë‰∏ãËΩΩ
    const link = document.createElement('a');
    link.href = url;
    link.style.display = 'none';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    // Âª∂ËøüÊòæÁ§∫ÊàêÂäüÊ∂àÊÅØ
    setTimeout(() => {
        if (format === 'json') {
            showNotification('‚úÖ JSONÊï∞ÊçÆÂØºÂá∫ÊàêÂäüÔºÅ', 'success');
        } else {
            if (encoding === 'gbk') {
                showNotification('‚úÖ CSVÊï∞ÊçÆÂØºÂá∫ÊàêÂäüÔºÅ‰ΩøÁî®GBKÁºñÁ†ÅÔºåÂ∫îËØ•ËÉΩÂú®Excel‰∏≠Ê≠£Á°ÆÊòæÁ§∫‰∏≠Êñá„ÄÇ', 'success');
            } else {
                showNotification('‚úÖ CSVÊï∞ÊçÆÂØºÂá∫ÊàêÂäüÔºÅ‰ΩøÁî®UTF-8ÁºñÁ†ÅÔºåÊ∑ªÂä†‰∫ÜBOMÊ†áËÆ∞„ÄÇ', 'success');
            }
        }
    }, 500);
}

// Á°ÆËÆ§Ê∏ÖÁ©∫Êï∞ÊçÆ
function confirmClearData() {
    // ‰ΩøÁî®BootstrapÊ®°ÊÄÅÊ°ÜÊàñËÄÖÊµèËßàÂô®Á°ÆËÆ§Ê°Ü
    const confirmed = confirm(
        '‚ö†Ô∏è Ë≠¶ÂëäÔºöÊ≠§Êìç‰ΩúÂ∞ÜÊ∞∏‰πÖÂà†Èô§ÊâÄÊúâÂéÜÂè≤Êï∞ÊçÆÔºÅ\n\n' +
        'ÂåÖÊã¨Ôºö\n' +
        '‚Ä¢ ÊâÄÊúâ‰ªªÂä°ËÆ∞ÂΩï\n' +
        '‚Ä¢ ÊâÄÊúâÁªüËÆ°Êï∞ÊçÆ\n' +
        '‚Ä¢ ÂΩìÂâçÊ≠£Âú®ËøõË°åÁöÑ‰ªªÂä°\n\n' +
        'Ê≠§Êìç‰ΩúÊó†Ê≥ïÊí§ÈîÄÔºåÁ°ÆÂÆöË¶ÅÁªßÁª≠ÂêóÔºü'
    );
    
    if (confirmed) {
        const doubleConfirm = confirm(
            'üî¥ ÊúÄÂêéÁ°ÆËÆ§ÔºöÊÇ®ÁúüÁöÑË¶ÅÂà†Èô§ÊâÄÊúâÊï∞ÊçÆÂêóÔºü\n\n' +
            'Âà†Èô§ÂêéÂ∞ÜÊó†Ê≥ïÊÅ¢Â§çÔºÅ'
        );
        
        if (doubleConfirm) {
            clearAllData();
        }
    }
}

// ÊâßË°åÊ∏ÖÁ©∫Êï∞ÊçÆ
function clearAllData() {
    // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
    const clearBtn = event.target;
    const originalText = clearBtn.innerHTML;
    clearBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Ê∏ÖÁ©∫‰∏≠...';
    clearBtn.disabled = true;
    
    fetch('/api/clear_data', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // ÊòæÁ§∫ÊàêÂäüÊ∂àÊÅØ
            showNotification('‚úÖ ' + data.message, 'success');
            
            // Âª∂ËøüÂà∑Êñ∞È°µÈù¢
            setTimeout(() => {
                location.reload();
            }, 1500);
        } else {
            showNotification('‚ùå Ê∏ÖÁ©∫Â§±Ë¥•: ' + (data.message || 'Êú™Áü•ÈîôËØØ'), 'error');
            clearBtn.innerHTML = originalText;
            clearBtn.disabled = false;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('‚ùå Ê∏ÖÁ©∫Â§±Ë¥•: ÁΩëÁªúÈîôËØØ', 'error');
        clearBtn.innerHTML = originalText;
        clearBtn.disabled = false;
    });
}

// ÊòæÁ§∫ÈÄöÁü•Ê∂àÊÅØ
function showNotification(message, type = 'info') {
    // ÂàõÂª∫ÈÄöÁü•ÂÖÉÁ¥†
    const notification = document.createElement('div');
    notification.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 1050; min-width: 300px;';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // Ê∑ªÂä†Âà∞È°µÈù¢
    document.body.appendChild(notification);
    
    // 3ÁßíÂêéËá™Âä®ÁßªÈô§
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 3000);
}

// ÁºñËæë‰ªªÂä°
function editSession(sessionId) {
    fetch(`/api/get_session/${sessionId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const session = data.session;
                
                // Â°´ÂÖÖË°®Âçï
                document.getElementById('editSessionId').value = sessionId;
                document.getElementById('editTaskName').value = session.task;
                document.getElementById('editCategory').value = session.category;
                document.getElementById('editStartDate').value = session.start_date;
                document.getElementById('editStartTime').value = session.start_time;
                document.getElementById('editEndDate').value = session.end_date || '';
                document.getElementById('editEndTime').value = session.end_time || '';
                
                // Êõ¥Êñ∞Ê®°ÊÄÅÊ°ÜÊ†áÈ¢ò
                document.getElementById('editModalTitle').textContent = 'ÁºñËæë‰ªªÂä°';
                
                // ÊòæÁ§∫Ê®°ÊÄÅÊ°Ü
                const modal = new bootstrap.Modal(document.getElementById('editSessionModal'));
                modal.show();
            } else {
                showNotification('‚ùå Ëé∑Âèñ‰ªªÂä°‰ø°ÊÅØÂ§±Ë¥•: ' + data.message, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('‚ùå ÁΩëÁªúÈîôËØØ', 'error');
        });
}

// ÂàõÂª∫Êñ∞‰ªªÂä°
function createNewSession() {
    // Ê∏ÖÁ©∫Ë°®Âçï
    document.getElementById('editSessionForm').reset();
    document.getElementById('editSessionId').value = '';
    
    // ËÆæÁΩÆÈªòËÆ§ÂÄº
    const now = new Date();
    const today = now.toISOString().split('T')[0];
    const currentTime = now.toTimeString().slice(0, 5);
    
    document.getElementById('editStartDate').value = today;
    document.getElementById('editStartTime').value = currentTime;
    document.getElementById('editCategory').value = 'study';
    
    // Êõ¥Êñ∞Ê®°ÊÄÅÊ°ÜÊ†áÈ¢ò
    document.getElementById('editModalTitle').textContent = 'Êñ∞Âª∫‰ªªÂä°';
    
    // ÊòæÁ§∫Ê®°ÊÄÅÊ°Ü
    const modal = new bootstrap.Modal(document.getElementById('editSessionModal'));
    modal.show();
}

// ‰øùÂ≠ò‰ªªÂä°
function saveSession() {
    const sessionId = document.getElementById('editSessionId').value;
    const isNewSession = sessionId === '';
    
    const formData = {
        task: document.getElementById('editTaskName').value,
        category: document.getElementById('editCategory').value,
        start_date: document.getElementById('editStartDate').value,
        start_time: document.getElementById('editStartTime').value,
        end_date: document.getElementById('editEndDate').value,
        end_time: document.getElementById('editEndTime').value
    };
    
    // È™åËØÅË°®Âçï
    if (!formData.task || !formData.category || !formData.start_date || !formData.start_time) {
        showNotification('‚ùå ËØ∑Â°´ÂÜôÊâÄÊúâÂøÖÈúÄÂ≠óÊÆµ', 'error');
        return;
    }
    
    const saveBtn = document.getElementById('saveSessionBtn');
    const originalText = saveBtn.innerHTML;
    saveBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> ‰øùÂ≠ò‰∏≠...';
    saveBtn.disabled = true;
    
    const url = isNewSession ? '/api/create_session' : `/api/update_session/${sessionId}`;
    
    fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('‚úÖ ' + data.message, 'success');
            
            // ÈöêËóèÊ®°ÊÄÅÊ°Ü
            const modal = bootstrap.Modal.getInstance(document.getElementById('editSessionModal'));
            modal.hide();
            
            // Âà∑Êñ∞È°µÈù¢
            setTimeout(() => {
                location.reload();
            }, 1000);
        } else {
            showNotification('‚ùå ‰øùÂ≠òÂ§±Ë¥•: ' + data.message, 'error');
        }
        
        saveBtn.innerHTML = originalText;
        saveBtn.disabled = false;
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('‚ùå ÁΩëÁªúÈîôËØØ', 'error');
        saveBtn.innerHTML = originalText;
        saveBtn.disabled = false;
    });
}

// Âà†Èô§‰ªªÂä°
function deleteSession(sessionId) {
    const confirmed = confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™‰ªªÂä°ÂêóÔºü\n\nÂà†Èô§ÂêéÂ∞ÜÊó†Ê≥ïÊÅ¢Â§çÔºÅ');
    
    if (confirmed) {
        fetch(`/api/delete_session/${sessionId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('‚úÖ ' + data.message, 'success');
                setTimeout(() => {
                    location.reload();
                }, 1000);
            } else {
                showNotification('‚ùå Âà†Èô§Â§±Ë¥•: ' + data.message, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('‚ùå ÁΩëÁªúÈîôËØØ', 'error');
        });
    }
}
</script>
{% endblock %}
